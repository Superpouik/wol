<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfyUI Mobile Interface</title>
    <link rel="stylesheet" href="styles-ios.css">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ComfyUI Mobile">
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>ComfyUI Mobile</h1>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator"></span>
                <span class="status-text">Connexion...</span>
            </div>
        </header>

        <main class="main">
            <!-- Onglet Workflow -->
            <div class="tab-content active" id="workflow">
                <!-- Gestion des workflows sauvegard√©s -->
                <div class="section">
                    <h2>üóÇÔ∏è Gestion des workflows</h2>
                    
                    <div class="workflow-management">
                        <div class="workflow-actions">
                            <button id="saveWorkflowBtn" class="btn btn-primary" onclick="comfyUI.saveCurrentWorkflow()" disabled>
                                üíæ Sauvegarder
                            </button>
                            
                            <div class="saved-workflows-container">
                                <select id="savedWorkflowsList" class="workflow-select" onchange="comfyUI.loadSavedWorkflow(this.value)">
                                    <option value="">üìÇ Mes workflows sauvegard√©s</option>
                                </select>
                                <button id="manageWorkflowBtn" class="btn btn-secondary" onclick="comfyUI.openWorkflowManager()" disabled>
                                    ‚öôÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <div class="export-import-actions">
                            <button id="exportAllBtn" class="btn btn-secondary" onclick="comfyUI.exportAllWorkflows()" disabled>
                                üì§ Exporter tous
                            </button>
                            <input type="file" id="importBackupFile" accept=".json" style="display: none;" onchange="comfyUI.importWorkflowBackup(this)">
                            <button id="importBackupBtn" class="btn btn-secondary" onclick="document.getElementById('importBackupFile').click()">
                                üì• Importer sauvegarde
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Import de workflow depuis fichier -->
                <div class="section">
                    <h2>üìÅ Import Workflow</h2>
                    <div class="file-input-container">
                        <input type="file" id="workflowFile" accept=".json" class="file-input">
                        <label for="workflowFile" class="file-label">
                            üìÅ Choisir un workflow (.json)
                        </label>
                    </div>
                    <div class="workflow-info" id="workflowInfo" style="display: none;">
                        <h3>Workflow charg√©</h3>
                        <div class="workflow-details"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>Param√®tres du Workflow</h2>
                    <div id="workflowParams" class="params-container">
                        <p class="no-workflow">Importez un workflow pour voir les param√®tres</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Quick Gen -->
            <div class="tab-content" id="quickgen">
                <div class="section">
                    <h2>G√©n√©ration Rapide</h2>
                    
                    <div class="quick-status" id="quickStatus">
                        <p class="no-workflow">Aucun workflow charg√©</p>
                    </div>
                    
                    <!-- Toggle FaceDetailer -->
                    <div class="toggle-section" id="faceDetailerSection">
                        <div class="toggle-header">
                            <label class="toggle-switch">
                                <input type="checkbox" id="faceDetailerToggle" onchange="comfyUI.toggleQuickFaceDetailer(this.checked)">
                                <span class="toggle-slider-round"></span>
                            </label>
                            <h3>üë§ FaceDetailer</h3>
                            <span class="availability-status" id="faceDetailerStatus">Non disponible</span>
                        </div>
                        <div class="toggle-content" id="faceDetailerContent" style="display: none;">
                            <!-- Param√®tres FaceDetailer -->
                            <div class="quick-params">
                                <div class="param-row">
                                    <label>Guide Size:</label>
                                    <input type="number" id="quick_face_guide_size" class="quick-input" value="832" onchange="comfyUI.updateQuickParam('face', 'guide_size', parseInt(this.value))">
                                </div>
                                <div class="param-row">
                                    <label>Max Size:</label>
                                    <input type="number" id="quick_face_max_size" class="quick-input" value="1216" onchange="comfyUI.updateQuickParam('face', 'max_size', parseInt(this.value))">
                                </div>
                                <div class="param-row">
                                    <label>Steps:</label>
                                    <input type="number" id="quick_face_steps" class="quick-input" value="20" onchange="comfyUI.updateQuickParam('face', 'steps', parseInt(this.value))">
                                </div>
                                <div class="param-row">
                                    <label>CFG:</label>
                                    <input type="number" id="quick_face_cfg" class="quick-input" value="5" step="0.1" onchange="comfyUI.updateQuickParam('face', 'cfg', parseFloat(this.value))">
                                </div>
                                <div class="param-row">
                                    <label>Sampler:</label>
                                    <select id="quick_face_sampler" class="quick-select" onchange="comfyUI.updateQuickParam('face', 'sampler_name', this.value)">
                                        <option value="euler_ancestral">Euler Ancestral</option>
                                        <option value="euler">Euler</option>
                                        <option value="dpmpp_2m">DPM++ 2M</option>
                                        <option value="dpmpp_sde">DPM++ SDE</option>
                                    </select>
                                </div>
                                <div class="param-row">
                                    <label>Scheduler:</label>
                                    <select id="quick_face_scheduler" class="quick-select" onchange="comfyUI.updateQuickParam('face', 'scheduler', this.value)">
                                        <option value="normal">Normal</option>
                                        <option value="simple">Simple</option>
                                        <option value="karras">Karras</option>
                                        <option value="exponential">Exponential</option>
                                    </select>
                                </div>
                                <div class="param-row">
                                    <label>SAM Detection:</label>
                                    <select id="quick_face_sam_hint" class="quick-select" onchange="comfyUI.updateQuickParam('face', 'sam_detection_hint', this.value)">
                                        <option value="center-1">Center-1</option>
                                        <option value="horizontal">Horizontal</option>
                                        <option value="vertical">Vertical</option>
                                        <option value="rect-4">Rect-4</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toggle ControlNet -->
                    <div class="toggle-section" id="controlNetSection">
                        <div class="toggle-header">
                            <label class="toggle-switch">
                                <input type="checkbox" id="controlNetToggle" onchange="comfyUI.toggleQuickControlNet(this.checked)">
                                <span class="toggle-slider-round"></span>
                            </label>
                            <h3>üéÆ ControlNet</h3>
                            <span class="availability-status" id="controlNetStatus">Non disponible</span>
                        </div>
                        <div class="toggle-content" id="controlNetContent" style="display: none;">
                            <!-- Interface Multi-ControlNet g√©n√©r√©e dynamiquement -->
                            <p class="loading">Chargement des ControlNets...</p>
                        </div>
                    </div>
                    
                    <!-- LoRAs -->
                    <div class="section-content" id="lorasSection" style="display: none;">
                        <h3>üß¨ LoRAs</h3>
                        
                        <div class="loras-management">
                            <!-- Interface d'ajout de LoRA -->
                            <div class="loras-add-section">
                                <div class="loras-search-container">
                                    <input type="text" id="loraSearchInput" class="lora-search-input" placeholder="üîç Rechercher un LoRA...">
                                    <select id="loraAddSelect" class="lora-select">
                                        <option value="">+ Ajouter LoRA</option>
                                    </select>
                                    <button id="addLoraBtn" class="btn btn-secondary" onclick="comfyUI.addQuickLora()" disabled>Ajouter</button>
                                </div>
                            </div>
                            
                            <!-- Liste des LoRAs actifs -->
                            <div id="activeLorasList" class="active-loras-list">
                                <p class="no-loras">Aucun LoRA configur√©</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prompts -->
                    <div class="section-content">
                        <h3>‚úçÔ∏è Prompts</h3>
                        <div class="prompt-section">
                            <div class="param-row full-width">
                                <label>Prompt Positif:</label>
                                <textarea id="quick_prompt_positive" class="quick-textarea" placeholder="D√©crivez votre image..." onchange="comfyUI.updateQuickParam('prompt', 'positive', this.value)"></textarea>
                            </div>
                            <div class="param-row full-width">
                                <label>Prompt N√©gatif:</label>
                                <textarea id="quick_prompt_negative" class="quick-textarea" placeholder="Ce que vous ne voulez pas..." onchange="comfyUI.updateQuickParam('prompt', 'negative', this.value)"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KSampler 1 -->
                    <div class="section-content">
                        <h3>‚öôÔ∏è KSampler 1 (Base)</h3>
                        <div class="sampler-params">
                            <div class="param-row seed-row">
                                <label>Seed:</label>
                                <div class="seed-input-container">
                                    <input type="number" id="quick_ks1_seed" class="quick-input" onchange="comfyUI.updateQuickParam('ks1', 'seed', parseInt(this.value))">
                                    <button class="btn-random" onclick="comfyUI.randomizeSeed('quick_ks1_seed', 'ks1')">üé≤</button>
                                </div>
                            </div>
                            <div class="param-row">
                                <label>Steps:</label>
                                <input type="number" id="quick_ks1_steps" class="quick-input" value="8" onchange="comfyUI.updateQuickParam('ks1', 'steps', parseInt(this.value))">
                            </div>
                            <div class="param-row">
                                <label>CFG:</label>
                                <input type="number" id="quick_ks1_cfg" class="quick-input" value="2" step="0.1" onchange="comfyUI.updateQuickParam('ks1', 'cfg', parseFloat(this.value))">
                            </div>
                            <div class="param-row">
                                <label>Denoise:</label>
                                <input type="number" id="quick_ks1_denoise" class="quick-input" value="1" step="0.01" min="0" max="1" onchange="comfyUI.updateQuickParam('ks1', 'denoise', parseFloat(this.value))">
                            </div>
                            <div class="param-row">
                                <label>Sampler:</label>
                                <select id="quick_ks1_sampler" class="quick-select" onchange="comfyUI.updateQuickParam('ks1', 'sampler_name', this.value)">
                                    <option value="euler_ancestral">Euler Ancestral</option>
                                    <option value="euler">Euler</option>
                                    <option value="dpmpp_2m">DPM++ 2M</option>
                                </select>
                            </div>
                            <div class="param-row">
                                <label>Scheduler:</label>
                                <select id="quick_ks1_scheduler" class="quick-select" onchange="comfyUI.updateQuickParam('ks1', 'scheduler', this.value)">
                                    <option value="normal">Normal</option>
                                    <option value="simple">Simple</option>
                                    <option value="karras">Karras</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KSampler 2 -->
                    <div class="section-content">
                        <h3>‚öôÔ∏è KSampler 2 (Hi-Res)</h3>
                        <div class="sampler-params">
                            <div class="param-row seed-row">
                                <label>Seed:</label>
                                <div class="seed-input-container">
                                    <input type="number" id="quick_ks2_seed" class="quick-input" onchange="comfyUI.updateQuickParam('ks2', 'seed', parseInt(this.value))">
                                    <button class="btn-random" onclick="comfyUI.randomizeSeed('quick_ks2_seed', 'ks2')">üé≤</button>
                                </div>
                            </div>
                            <div class="param-row">
                                <label>Steps:</label>
                                <input type="number" id="quick_ks2_steps" class="quick-input" value="15" onchange="comfyUI.updateQuickParam('ks2', 'steps', parseInt(this.value))">
                            </div>
                            <div class="param-row">
                                <label>CFG:</label>
                                <input type="number" id="quick_ks2_cfg" class="quick-input" value="7" step="0.1" onchange="comfyUI.updateQuickParam('ks2', 'cfg', parseFloat(this.value))">
                            </div>
                            <div class="param-row">
                                <label>Denoise:</label>
                                <input type="number" id="quick_ks2_denoise" class="quick-input" value="0.2" step="0.01" min="0" max="1" onchange="comfyUI.updateQuickParam('ks2', 'denoise', parseFloat(this.value))">
                            </div>
                            <div class="param-row">
                                <label>Sampler:</label>
                                <select id="quick_ks2_sampler" class="quick-select" onchange="comfyUI.updateQuickParam('ks2', 'sampler_name', this.value)">
                                    <option value="euler_ancestral">Euler Ancestral</option>
                                    <option value="euler">Euler</option>
                                    <option value="dpmpp_2m">DPM++ 2M</option>
                                </select>
                            </div>
                            <div class="param-row">
                                <label>Scheduler:</label>
                                <select id="quick_ks2_scheduler" class="quick-select" onchange="comfyUI.updateQuickParam('ks2', 'scheduler', this.value)">
                                    <option value="normal">Normal</option>
                                    <option value="simple">Simple</option>
                                    <option value="karras">Karras</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Options de g√©n√©ration -->
                    <div class="section-content">
                        <h3>‚öôÔ∏è Options de g√©n√©ration</h3>
                        <div class="param-row">
                            <label class="checkbox-container">
                                <input type="checkbox" id="autoRandomSeeds" checked>
                                <span class="checkbox-checkmark"></span>
                                Randomiser automatiquement les seeds √† chaque g√©n√©ration
                            </label>
                        </div>
                        <div class="param-row">
                            <label class="checkbox-container">
                                <input type="checkbox" id="enablePreviews" checked>
                                <span class="checkbox-checkmark"></span>
                                Afficher les previews en temps r√©el pendant la g√©n√©ration
                            </label>
                        </div>
                    </div>
                    
                    <!-- Bouton G√©n√©ration -->
                    <div class="generate-section">
                        <button id="quickGenerateBtn" class="btn btn-primary" disabled>
                            ‚ö° G√©n√©ration Rapide
                        </button>
                        <div class="quick-generation-progress" id="quickGenerationProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <div class="progress-text">G√©n√©ration en cours...</div>
                            
                            <!-- Preview dynamique pendant la g√©n√©ration -->
                            <div class="preview-container" id="previewContainer" style="display: none;">
                                <h4>Preview en temps r√©el:</h4>
                                <div class="preview-image-container">
                                    <img id="previewImage" src="" alt="Preview en cours" class="preview-image">
                                    <div class="preview-info" id="previewInfo"></div>
                                </div>
                                <div class="preview-history" id="previewHistory"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview R√©sultat -->
                    <div class="section-content">
                        <h3>üÜºÔ∏è R√©sultat</h3>
                        <div id="quickGenerationResult" class="result-container">
                            <p class="no-result">Aucune g√©n√©ration effectu√©e</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Mod√®les -->
            <div class="tab-content" id="models">
                <div class="section">
                    <h2>Mod√®les disponibles</h2>
                    <button id="refreshModels" class="btn btn-secondary">üîÑ Actualiser</button>
                    
                    <div class="model-categories">
                        <div class="model-category">
                            <h3>Checkpoints</h3>
                            <div id="checkpointsList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category">
                            <h3>LoRAs</h3>
                            <div id="lorasList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category">
                            <h3>ControlNets</h3>
                            <div id="controlnetsList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category">
                            <h3>VAE</h3>
                            <div id="vaesList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category" id="upscaleCategory" style="display: none;">
                            <h3>Upscale Models</h3>
                            <div id="upscalesList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category" id="embeddingsCategory" style="display: none;">
                            <h3>Embeddings</h3>
                            <div id="embeddingsList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet G√©n√©ration -->
            <div class="tab-content" id="generate">
                <div class="section">
                    <h2>G√©n√©ration d'image</h2>
                    
                    <div class="workflow-status" id="workflowStatus">
                        <div class="status-message">
                            <p>Aucun workflow charg√©</p>
                        </div>
                    </div>
                    
                    <div class="generate-controls">
                        <button id="generateBtn" class="btn btn-primary" disabled>
                            ‚ö° G√©n√©rer l'image
                        </button>
                        <button id="previewWorkflowBtn" class="btn btn-secondary" disabled>
                            üîç Pr√©visualiser le workflow
                        </button>
                        <div class="generation-progress" id="generationProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <div class="progress-text">G√©n√©ration en cours...</div>
                        </div>
                    </div>
                </div>
                
                <div class="section" id="workflowPreviewSection" style="display: none;">
                    <h2>Aper√ßu du workflow</h2>
                    <div class="workflow-preview">
                        <pre id="workflowPreview" class="workflow-json"></pre>
                    </div>
                    <div class="preview-controls">
                        <button id="closePreviewBtn" class="btn btn-secondary">‚ùå Fermer</button>
                        <button id="downloadWorkflowBtn" class="btn btn-secondary">üíæ T√©l√©charger JSON</button>
                    </div>
                </div>

                <div class="section">
                    <h2>R√©sultat</h2>
                    <div id="generationResult" class="result-container">
                        <p class="no-result">Aucune g√©n√©ration effectu√©e</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Galerie -->
            <div class="tab-content" id="gallery">
                <div class="section">
                    <h2>Galerie</h2>
                    <div class="gallery-controls">
                        <button id="clearGallery" class="btn btn-secondary">üóëÔ∏è Vider la galerie</button>
                    </div>
                    <div id="galleryGrid" class="gallery-grid">
                        <p class="no-images">Aucune image g√©n√©r√©e</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Settings -->
            <div class="tab-content" id="settings">
                <div class="section">
                    <h2>‚öôÔ∏è Configuration du serveur</h2>
                    
                    <div class="settings-form">
                        <div class="setting-group">
                            <label for="serverUrl" class="setting-label">
                                üñ•Ô∏è Adresse du serveur ComfyUI API
                            </label>
                            <input type="text" 
                                   id="serverUrl" 
                                   class="setting-input" 
                                   placeholder="https://comfyui-mobile.duckdns.org/api"
                                   value="https://comfyui-mobile.duckdns.org/api">
                            <small class="setting-hint">URL de l'API REST de ComfyUI (avec /api √† la fin)</small>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                üîå Adresse WebSocket (Auto-g√©n√©r√©e)
                            </label>
                            <input type="text" 
                                   id="websocketUrl" 
                                   class="setting-input" 
                                   readonly
                                   style="background-color: #2d2d2d; color: #888;">
                            <small class="setting-hint">‚ú® G√©n√©r√© automatiquement depuis l'adresse serveur (/api ‚Üí /ws)</small>
                        </div>

                        <div class="setting-group">
                            <h3>üîó Test de connexion</h3>
                            <div class="connection-tests">
                                <div class="connection-test">
                                    <button id="testServerConnection" class="btn btn-secondary">
                                        üß™ Tester l'API REST
                                    </button>
                                    <span id="serverStatus" class="connection-result">Non test√©</span>
                                </div>
                                
                                <div class="connection-test">
                                    <button id="testWebSocketConnection" class="btn btn-secondary">
                                        üß™ Tester WebSocket
                                    </button>
                                    <span id="websocketStatus" class="connection-result">Non test√©</span>
                                </div>
                            </div>
                        </div>

                        <!-- Options d'interface -->
                        <div class="setting-group">
                            <label class="setting-label">
                                üéõÔ∏è Options d'interface
                            </label>
                            <div class="checkbox-container">
                                <input type="checkbox" id="showModelsTab" onchange="comfyUI.toggleModelsTab(this.checked)">
                                <span class="checkbox-checkmark"></span>
                                Afficher l'onglet Mod√®les (debug)
                            </div>
                        </div>

                        <div class="setting-actions">
                            <button id="saveSettings" class="btn btn-primary">
                                üíæ Sauvegarder les param√®tres
                            </button>
                            <button id="resetSettings" class="btn btn-secondary">
                                üîÑ R√©initialiser par d√©faut
                            </button>
                        </div>
                    </div>

                    <div class="settings-info">
                        <h3>‚ÑπÔ∏è Informations</h3>
                        <ul>
                            <li><strong>API REST</strong> : Utilis√©e pour envoyer les workflows et r√©cup√©rer les images</li>
                            <li><strong>WebSocket</strong> : Utilis√©e pour les previews temps r√©el et la progression</li>
                            <li><strong>Port par d√©faut</strong> : ComfyUI utilise g√©n√©ralement le port 8188 ou 8000</li>
                            <li><strong>HTTPS/WSS</strong> : N√©cessaire si l'interface est servie en HTTPS</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Navigation en bas avec ic√¥nes -->
            <div class="tabs bottom-nav">
                <button class="tab active" data-tab="workflow" title="Workflow">
                    <span class="tab-icon">üìã</span>
                    <span class="tab-label">Workflow</span>
                </button>
                <button class="tab" data-tab="quickgen" title="G√©n√©ration Rapide">
                    <span class="tab-icon">‚ö°</span>
                    <span class="tab-label">Quick Gen</span>
                </button>
                <button class="tab" data-tab="models" id="modelsTab" style="display: none;" title="Mod√®les">
                    <span class="tab-icon">üéØ</span>
                    <span class="tab-label">Mod√®les</span>
                </button>
                <button class="tab" data-tab="generate" title="G√©n√©rer">
                    <span class="tab-icon">üé®</span>
                    <span class="tab-label">G√©n√©rer</span>
                </button>
                <button class="tab" data-tab="gallery" title="Galerie">
                    <span class="tab-icon">üñºÔ∏è</span>
                    <span class="tab-label">Galerie</span>
                </button>
                <button class="tab" data-tab="settings" title="Param√®tres">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span class="tab-label">Settings</span>
                </button>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
</body>
</html>