<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ComfyUI Mobile Interface</title>
    
    <!-- CSS critique INLINE pour PWA - √©limine l'√©cran blanc -->
    <style>
        /* CSS critique minimal pour PWA */
        body{background:linear-gradient(145deg,#000 0%,#1C1C1E 50%,#2C2C2E 100%);font-family:-apple-system,system-ui,sans-serif;color:#fff;margin:0;padding:0;overflow-x:hidden;-webkit-overflow-scrolling:touch}
        .splash-screen{position:fixed;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(145deg,#000 0%,#1C1C1E 50%,#2C2C2E 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10000}
        .splash-content{display:flex;flex-direction:column;align-items:center;text-align:center;animation:fadeIn 1s ease}
        .splash-title{font-size:32px;font-weight:700;background:linear-gradient(135deg,#007AFF,#AF52DE,#FF2D92);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px;animation:slideUp .8s ease .3s both}
        .splash-subtitle{font-size:17px;color:rgba(235,235,245,.6);margin-bottom:48px;animation:slideUp .8s ease .5s both}
        .loading-dots{display:flex;gap:8px;margin:16px 0}
        .loading-dots span{width:8px;height:8px;background:linear-gradient(135deg,#007AFF,#AF52DE);border-radius:50%;animation:pulse 1.5s infinite;box-shadow:0 0 15px rgba(0,122,255,.5)}
        .loading-dots span:nth-child(2){animation-delay:.3s}
        .loading-dots span:nth-child(3){animation-delay:.6s}
        .splash-version{position:absolute;bottom:40px;font-size:11px;color:rgba(235,235,245,.3);animation:slideUp 1s ease 1.5s both}
        body:not(.loaded) .app{opacity:0;visibility:hidden}
        @keyframes fadeIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes pulse{0%,100%{transform:scale(1);opacity:.7}50%{transform:scale(1.3);opacity:1}}
        @media(max-width:390px){.splash-title{font-size:28px}.splash-subtitle{font-size:14px}}
        @supports(padding:max(0px)){.splash-screen{padding:max(env(safe-area-inset-top),0) max(env(safe-area-inset-right),0) max(env(safe-area-inset-bottom),0) max(env(safe-area-inset-left),0)}}
    </style>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Interface mobile pour ComfyUI - G√©n√©ration d'images par IA">
    <meta name="theme-color" content="#007AFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ComfyUI Mobile">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="ComfyUI Mobile">
    
    <!-- Favicon & App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' fill='%23007AFF'%3E%3Crect width='32' height='32' rx='8' fill='%23000'/%3E%3Cpath d='M8 12h16v8H8z' fill='%23007AFF'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect width='180' height='180' rx='40' fill='%23007AFF'/%3E%3Cpath d='M45 80h90v40H45z' fill='%23fff'/%3E%3C/svg%3E">
    
    <!-- Manifest for PWA -->
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="styles-improved.css">
</head>
<body>
    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-content">
            <div class="splash-icon">
                <div class="comfyui-logo">
                    <svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#007AFF"/>
                                <stop offset="50%" stop-color="#AF52DE"/>
                                <stop offset="100%" stop-color="#FF2D92"/>
                            </linearGradient>
                        </defs>
                        <rect width="80" height="80" rx="20" fill="url(#logoGradient)"/>
                        <rect x="20" y="30" width="40" height="20" rx="4" fill="white" opacity="0.9"/>
                        <circle cx="30" cy="55" r="3" fill="white" opacity="0.7"/>
                        <circle cx="40" cy="55" r="3" fill="white" opacity="0.7"/>
                        <circle cx="50" cy="55" r="3" fill="white" opacity="0.7"/>
                    </svg>
                </div>
            </div>
            <div class="splash-title">ComfyUI Mobile</div>
            <div class="splash-subtitle">Interface IA G√©n√©rateur d'Images</div>
            <div class="splash-loading">
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="loading-text">Chargement...</div>
            </div>
        </div>
        <div class="splash-version">v1.0</div>
    </div>

    <div class="app">
        <header class="header">
            <h1>ComfyUI Mobile</h1>
            <div class="connection-status" id="connectionStatus">
                <span class="status-indicator"></span>
                <span class="status-text">Connexion...</span>
            </div>
        </header>

        <main class="main">
            <!-- Onglet Workflow -->
            <div class="tab-content active" id="workflow">
                <!-- Gestion des workflows sauvegard√©s -->
                <div class="section">
                    <h2>üóÇÔ∏è Gestion des workflows</h2>
                    
                    <div class="workflow-management">
                        <div class="workflow-actions">
                            <button id="saveWorkflowBtn" class="btn btn-primary" onclick="comfyUI.saveCurrentWorkflow()" disabled>
                                üíæ Sauvegarder
                            </button>
                            
                            <div class="saved-workflows-container">
                                <select id="savedWorkflowsList" class="workflow-select" onchange="comfyUI.loadSavedWorkflow(this.value)">
                                    <option value="">üìÇ Mes workflows sauvegard√©s</option>
                                </select>
                                <button id="manageWorkflowBtn" class="btn btn-secondary" onclick="comfyUI.openWorkflowManager()" disabled>
                                    ‚öôÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <div class="export-import-actions">
                            <button id="exportAllBtn" class="btn btn-secondary" onclick="comfyUI.exportAllWorkflows()" disabled>
                                üì§ Exporter tous
                            </button>
                            <input type="file" id="importBackupFile" accept=".json" style="display: none;" onchange="comfyUI.importWorkflowBackup(this)">
                            <button id="importBackupBtn" class="btn btn-secondary" onclick="document.getElementById('importBackupFile').click()">
                                üì• Importer sauvegarde
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Import de workflow depuis fichier -->
                <div class="section">
                    <h2>üìÅ Import Workflow</h2>
                    <div class="file-input-container">
                        <input type="file" id="workflowFile" accept=".json" class="file-input">
                        <label for="workflowFile" class="file-label">
                            üìÅ Choisir un workflow (.json)
                        </label>
                    </div>
                    <div class="workflow-info" id="workflowInfo" style="display: none;">
                        <h3>Workflow charg√©</h3>
                        <div class="workflow-details"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>Param√®tres du Workflow</h2>
                    <div id="workflowParams" class="params-container">
                        <p class="no-workflow">Importez un workflow pour voir les param√®tres</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Quick Gen -->
            <div class="tab-content" id="quickgen">
                <div class="section">
                    <h2>G√©n√©ration Rapide</h2>
                    
                    <div class="quick-status" id="quickStatus">
                        <p class="no-workflow">Aucun workflow charg√©</p>
                    </div>
                    
                    <!-- Toggle FaceDetailer -->
                    <div class="toggle-section" id="faceDetailerSection">
                        <div class="toggle-header" onclick="handleHeaderClick(event, 'faceDetailerContent', this)">
                            <div class="toggle-header-left">
                                <label class="toggle-switch" onclick="event.stopPropagation();">
                                    <input type="checkbox" id="faceDetailerToggle" onchange="comfyUI.toggleQuickFaceDetailer(this.checked)">
                                    <span class="toggle-slider-round"></span>
                                </label>
                                <h3>üë§ FaceDetailer</h3>
                                <span class="availability-status" id="faceDetailerStatus">Non disponible</span>
                            </div>
                            <button class="collapse-btn" onclick="event.stopPropagation(); toggleSectionCollapse('faceDetailerContent', this)" title="R√©duire/Agrandir">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </div>
                        <div class="toggle-content" id="faceDetailerContent" style="display: none;">
                            <!-- Param√®tres FaceDetailer -->
                            <div class="quick-params">
                                <div class="param-row">
                                    <label>Guide Size:</label>
                                    <input type="number" id="quick_face_guide_size" class="quick-input" value="832" onchange="comfyUI.updateQuickParam('face', 'guide_size', parseInt(this.value))">
                                </div>
                                <div class="param-row">
                                    <label>Max Size:</label>
                                    <input type="number" id="quick_face_max_size" class="quick-input" value="1216" onchange="comfyUI.updateQuickParam('face', 'max_size', parseInt(this.value))">
                                </div>
                                <div class="param-row">
                                    <label>Steps:</label>
                                    <input type="number" id="quick_face_steps" class="quick-input" value="20" onchange="comfyUI.updateQuickParam('face', 'steps', parseInt(this.value))">
                                </div>
                                <div class="param-row">
                                    <label>CFG:</label>
                                    <input type="number" id="quick_face_cfg" class="quick-input" value="5" step="0.1" onchange="comfyUI.updateQuickParam('face', 'cfg', parseFloat(this.value))">
                                </div>
                                <div class="param-row">
                                    <label>Sampler:</label>
                                    <select id="quick_face_sampler" class="quick-select" onchange="comfyUI.updateQuickParam('face', 'sampler_name', this.value)">
                                        <option value="euler_ancestral">Euler Ancestral</option>
                                        <option value="euler">Euler</option>
                                        <option value="dpmpp_2m">DPM++ 2M</option>
                                        <option value="dpmpp_sde">DPM++ SDE</option>
                                    </select>
                                </div>
                                <div class="param-row">
                                    <label>Scheduler:</label>
                                    <select id="quick_face_scheduler" class="quick-select" onchange="comfyUI.updateQuickParam('face', 'scheduler', this.value)">
                                        <option value="normal">Normal</option>
                                        <option value="simple">Simple</option>
                                        <option value="karras">Karras</option>
                                        <option value="exponential">Exponential</option>
                                    </select>
                                </div>
                                <div class="param-row">
                                    <label>SAM Detection:</label>
                                    <select id="quick_face_sam_hint" class="quick-select" onchange="comfyUI.updateQuickParam('face', 'sam_detection_hint', this.value)">
                                        <option value="center-1">Center-1</option>
                                        <option value="horizontal">Horizontal</option>
                                        <option value="vertical">Vertical</option>
                                        <option value="rect-4">Rect-4</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toggle ControlNet -->
                    <div class="toggle-section" id="controlNetSection">
                        <div class="toggle-header" onclick="handleHeaderClick(event, 'controlNetContent', this)">
                            <div class="toggle-header-left">
                                <label class="toggle-switch" onclick="event.stopPropagation();">
                                    <input type="checkbox" id="controlNetToggle" onchange="comfyUI.toggleQuickControlNet(this.checked)">
                                    <span class="toggle-slider-round"></span>
                                </label>
                                <h3>üéÆ ControlNet</h3>
                                <span class="availability-status" id="controlNetStatus">Non disponible</span>
                            </div>
                            <button class="collapse-btn" onclick="event.stopPropagation(); toggleSectionCollapse('controlNetContent', this)" title="R√©duire/Agrandir">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </div>
                        <div class="toggle-content" id="controlNetContent" style="display: none;">
                            <!-- Interface Multi-ControlNet g√©n√©r√©e dynamiquement -->
                            <p class="loading">Chargement des ControlNets...</p>
                        </div>
                    </div>
                    
                    <!-- LoRAs -->
                    <div class="section-content collapsible-section" id="lorasSection" style="display: none;">
                        <div class="section-header" onclick="handleHeaderClick(event, 'lorasContent', this)">
                            <h3>üß¨ LoRAs</h3>
                            <button class="collapse-btn" onclick="event.stopPropagation(); toggleSectionCollapse('lorasContent', this)" title="R√©duire/Agrandir">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </div>
                        <div class="section-content-inner" id="lorasContent">
                        
                        <div class="loras-management">
                            <!-- Interface d'ajout de LoRA -->
                            <div class="loras-add-section">
                                <div class="loras-search-container">
                                    <input type="text" id="loraSearchInput" class="lora-search-input" placeholder="üîç Rechercher un LoRA...">
                                    <select id="loraAddSelect" class="lora-select">
                                        <option value="">+ Ajouter LoRA</option>
                                    </select>
                                    <button id="addLoraBtn" class="btn btn-secondary" onclick="comfyUI.addQuickLora()" disabled>Ajouter</button>
                                </div>
                            </div>
                            
                            <!-- Liste des LoRAs actifs -->
                            <div id="activeLorasList" class="active-loras-list">
                                <p class="no-loras">Aucun LoRA configur√©</p>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Prompts -->
                    <div class="section-content">
                        <h3>‚úçÔ∏è Prompts</h3>
                        <div class="prompt-section">
                            <div class="param-row full-width">
                                <label>Prompt Positif:</label>
                                <textarea id="quick_prompt_positive" class="quick-textarea" placeholder="D√©crivez votre image..." onchange="comfyUI.updateQuickParam('prompt', 'positive', this.value)"></textarea>
                            </div>
                            <div class="param-row full-width">
                                <label>Prompt N√©gatif:</label>
                                <textarea id="quick_prompt_negative" class="quick-textarea" placeholder="Ce que vous ne voulez pas..." onchange="comfyUI.updateQuickParam('prompt', 'negative', this.value)"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- KSampler 1 -->
                    <div class="section-content collapsible-section">
                        <div class="section-header" onclick="handleHeaderClick(event, 'ksampler1Content', this)">
                            <h3>‚öôÔ∏è KSampler 1 (Base)</h3>
                            <button class="collapse-btn" onclick="event.stopPropagation(); toggleSectionCollapse('ksampler1Content', this)" title="R√©duire/Agrandir">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </div>
                        <div class="section-content-inner" id="ksampler1Content">
                        <div class="sampler-params">
                            <div class="param-row seed-row">
                                <label>Seed:</label>
                                <div class="seed-input-container">
                                    <input type="number" id="quick_ks1_seed" class="quick-input" onchange="comfyUI.updateQuickParam('ks1', 'seed', parseInt(this.value))">
                                    <button class="btn-random" onclick="comfyUI.randomizeSeed('quick_ks1_seed', 'ks1')">üé≤</button>
                                </div>
                            </div>
                            <div class="param-row">
                                <label>Steps:</label>
                                <input type="number" id="quick_ks1_steps" class="quick-input" value="8" onchange="comfyUI.updateQuickParam('ks1', 'steps', parseInt(this.value))">
                            </div>
                            <div class="param-row">
                                <label>CFG:</label>
                                <input type="number" id="quick_ks1_cfg" class="quick-input" value="2" step="0.1" onchange="comfyUI.updateQuickParam('ks1', 'cfg', parseFloat(this.value))">
                            </div>
                            <div class="param-row">
                                <label>Denoise:</label>
                                <input type="number" id="quick_ks1_denoise" class="quick-input" value="1" step="0.01" min="0" max="1" onchange="comfyUI.updateQuickParam('ks1', 'denoise', parseFloat(this.value))">
                            </div>
                            <div class="param-row">
                                <label>Sampler:</label>
                                <select id="quick_ks1_sampler" class="quick-select" onchange="comfyUI.updateQuickParam('ks1', 'sampler_name', this.value)">
                                    <option value="euler_ancestral">Euler Ancestral</option>
                                    <option value="euler">Euler</option>
                                    <option value="dpmpp_2m">DPM++ 2M</option>
                                </select>
                            </div>
                            <div class="param-row">
                                <label>Scheduler:</label>
                                <select id="quick_ks1_scheduler" class="quick-select" onchange="comfyUI.updateQuickParam('ks1', 'scheduler', this.value)">
                                    <option value="normal">Normal</option>
                                    <option value="simple">Simple</option>
                                    <option value="karras">Karras</option>
                                </select>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- KSampler 2 -->
                    <div class="section-content collapsible-section">
                        <div class="section-header" onclick="handleHeaderClick(event, 'ksampler2Content', this)">
                            <h3>‚öôÔ∏è KSampler 2 (Hi-Res)</h3>
                            <button class="collapse-btn" onclick="event.stopPropagation(); toggleSectionCollapse('ksampler2Content', this)" title="R√©duire/Agrandir">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </div>
                        <div class="section-content-inner" id="ksampler2Content">
                        <div class="sampler-params">
                            <div class="param-row seed-row">
                                <label>Seed:</label>
                                <div class="seed-input-container">
                                    <input type="number" id="quick_ks2_seed" class="quick-input" onchange="comfyUI.updateQuickParam('ks2', 'seed', parseInt(this.value))">
                                    <button class="btn-random" onclick="comfyUI.randomizeSeed('quick_ks2_seed', 'ks2')">üé≤</button>
                                </div>
                            </div>
                            <div class="param-row">
                                <label>Steps:</label>
                                <input type="number" id="quick_ks2_steps" class="quick-input" value="15" onchange="comfyUI.updateQuickParam('ks2', 'steps', parseInt(this.value))">
                            </div>
                            <div class="param-row">
                                <label>CFG:</label>
                                <input type="number" id="quick_ks2_cfg" class="quick-input" value="7" step="0.1" onchange="comfyUI.updateQuickParam('ks2', 'cfg', parseFloat(this.value))">
                            </div>
                            <div class="param-row">
                                <label>Denoise:</label>
                                <input type="number" id="quick_ks2_denoise" class="quick-input" value="0.2" step="0.01" min="0" max="1" onchange="comfyUI.updateQuickParam('ks2', 'denoise', parseFloat(this.value))">
                            </div>
                            <div class="param-row">
                                <label>Sampler:</label>
                                <select id="quick_ks2_sampler" class="quick-select" onchange="comfyUI.updateQuickParam('ks2', 'sampler_name', this.value)">
                                    <option value="euler_ancestral">Euler Ancestral</option>
                                    <option value="euler">Euler</option>
                                    <option value="dpmpp_2m">DPM++ 2M</option>
                                </select>
                            </div>
                            <div class="param-row">
                                <label>Scheduler:</label>
                                <select id="quick_ks2_scheduler" class="quick-select" onchange="comfyUI.updateQuickParam('ks2', 'scheduler', this.value)">
                                    <option value="normal">Normal</option>
                                    <option value="simple">Simple</option>
                                    <option value="karras">Karras</option>
                                </select>
                            </div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Options de g√©n√©ration -->
                    <div class="section-content collapsible-section">
                        <div class="section-header" onclick="handleHeaderClick(event, 'generationOptionsContent', this)">
                            <h3>‚öôÔ∏è Options de g√©n√©ration</h3>
                            <button class="collapse-btn" onclick="event.stopPropagation(); toggleSectionCollapse('generationOptionsContent', this)" title="R√©duire/Agrandir">
                                <span class="collapse-icon">‚ñº</span>
                            </button>
                        </div>
                        <div class="section-content-inner" id="generationOptionsContent">
                        <div class="param-row">
                            <label class="checkbox-container">
                                <input type="checkbox" id="autoRandomSeeds" checked>
                                <span class="checkbox-checkmark"></span>
                                Randomiser automatiquement les seeds √† chaque g√©n√©ration
                            </label>
                        </div>
                        <div class="param-row">
                            <label class="checkbox-container">
                                <input type="checkbox" id="enablePreviews" checked>
                                <span class="checkbox-checkmark"></span>
                                Afficher les previews en temps r√©el pendant la g√©n√©ration
                            </label>
                        </div>
                        </div>
                    </div>
                    
                    <!-- Bouton G√©n√©ration -->
                    <div class="generate-section">
                        <button id="quickGenerateBtn" class="btn btn-primary" disabled>
                            ‚ö° G√©n√©ration Rapide
                        </button>
                        <div class="quick-generation-progress" id="quickGenerationProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <div class="progress-text">G√©n√©ration en cours...</div>
                            
                            <!-- Preview dynamique pendant la g√©n√©ration -->
                            <div class="preview-container" id="previewContainer" style="display: none;">
                                <h4>Preview en temps r√©el:</h4>
                                <div class="preview-image-container">
                                    <img id="previewImage" src="" alt="Preview en cours" class="preview-image">
                                    <div class="preview-info" id="previewInfo"></div>
                                </div>
                                <div class="preview-history" id="previewHistory"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview R√©sultat -->
                    <div class="section-content">
                        <h3>üÜºÔ∏è R√©sultat</h3>
                        <div id="quickGenerationResult" class="result-container">
                            <p class="no-result">Aucune g√©n√©ration effectu√©e</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet Mod√®les -->
            <div class="tab-content" id="models">
                <div class="section">
                    <h2>Mod√®les disponibles</h2>
                    <button id="refreshModels" class="btn btn-secondary">üîÑ Actualiser</button>
                    
                    <div class="model-categories">
                        <div class="model-category">
                            <h3>Checkpoints</h3>
                            <div id="checkpointsList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category">
                            <h3>LoRAs</h3>
                            <div id="lorasList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category">
                            <h3>ControlNets</h3>
                            <div id="controlnetsList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category">
                            <h3>VAE</h3>
                            <div id="vaesList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category" id="upscaleCategory" style="display: none;">
                            <h3>Upscale Models</h3>
                            <div id="upscalesList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                        
                        <div class="model-category" id="embeddingsCategory" style="display: none;">
                            <h3>Embeddings</h3>
                            <div id="embeddingsList" class="model-list">
                                <div class="loading">Chargement...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Onglet G√©n√©ration -->
            <div class="tab-content" id="generate">
                <div class="section">
                    <h2>G√©n√©ration d'image</h2>
                    
                    <div class="workflow-status" id="workflowStatus">
                        <div class="status-message">
                            <p>Aucun workflow charg√©</p>
                        </div>
                    </div>
                    
                    <div class="generate-controls">
                        <button id="generateBtn" class="btn btn-primary" disabled>
                            ‚ö° G√©n√©rer l'image
                        </button>
                        <button id="previewWorkflowBtn" class="btn btn-secondary" disabled>
                            üîç Pr√©visualiser le workflow
                        </button>
                        <div class="generation-progress" id="generationProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <div class="progress-text">G√©n√©ration en cours...</div>
                        </div>
                    </div>
                </div>
                
                <div class="section" id="workflowPreviewSection" style="display: none;">
                    <h2>Aper√ßu du workflow</h2>
                    <div class="workflow-preview">
                        <pre id="workflowPreview" class="workflow-json"></pre>
                    </div>
                    <div class="preview-controls">
                        <button id="closePreviewBtn" class="btn btn-secondary">‚ùå Fermer</button>
                        <button id="downloadWorkflowBtn" class="btn btn-secondary">üíæ T√©l√©charger JSON</button>
                    </div>
                </div>

                <div class="section">
                    <h2>R√©sultat</h2>
                    <div id="generationResult" class="result-container">
                        <p class="no-result">Aucune g√©n√©ration effectu√©e</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Galerie -->
            <div class="tab-content" id="gallery">
                <div class="section">
                    <h2>Galerie</h2>
                    <div class="gallery-controls">
                        <button id="clearGallery" class="btn btn-secondary">üóëÔ∏è Vider la galerie</button>
                    </div>
                    <div id="galleryGrid" class="gallery-grid">
                        <p class="no-images">Aucune image g√©n√©r√©e</p>
                    </div>
                </div>
            </div>

            <!-- Onglet Settings -->
            <div class="tab-content" id="settings">
                <div class="section">
                    <h2>‚öôÔ∏è Configuration du serveur</h2>
                    
                    <div class="settings-form">
                        <div class="setting-group">
                            <label for="serverUrl" class="setting-label">
                                üñ•Ô∏è Adresse du serveur ComfyUI API
                            </label>
                            <input type="text" 
                                   id="serverUrl" 
                                   class="setting-input" 
                                   placeholder="https://comfyui-mobile.duckdns.org/api"
                                   value="https://comfyui-mobile.duckdns.org/api">
                            <small class="setting-hint">URL de l'API REST de ComfyUI (avec /api √† la fin)</small>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label">
                                üîå Adresse WebSocket (Auto-g√©n√©r√©e)
                            </label>
                            <input type="text" 
                                   id="websocketUrl" 
                                   class="setting-input" 
                                   readonly
                                   style="background-color: #2d2d2d; color: #888;">
                            <small class="setting-hint">‚ú® G√©n√©r√© automatiquement depuis l'adresse serveur (/api ‚Üí /ws)</small>
                        </div>

                        <div class="setting-group">
                            <h3>üîó Test de connexion</h3>
                            <div class="connection-tests">
                                <div class="connection-test">
                                    <button id="testServerConnection" class="btn btn-secondary">
                                        üß™ Tester l'API REST
                                    </button>
                                    <span id="serverStatus" class="connection-result">Non test√©</span>
                                </div>
                                
                                <div class="connection-test">
                                    <button id="testWebSocketConnection" class="btn btn-secondary">
                                        üß™ Tester WebSocket
                                    </button>
                                    <span id="websocketStatus" class="connection-result">Non test√©</span>
                                </div>
                            </div>
                        </div>

                        <!-- Options d'interface -->
                        <div class="setting-group">
                            <label class="setting-label">
                                üéõÔ∏è Options d'interface
                            </label>
                            <div class="checkbox-container">
                                <input type="checkbox" id="showModelsTab" onchange="comfyUI.toggleModelsTab(this.checked)">
                                <span class="checkbox-checkmark"></span>
                                Afficher l'onglet Mod√®les (debug)
                            </div>
                        </div>

                        <!-- Mode Plein √âcran -->
                        <div class="setting-group">
                            <label class="setting-label">üì± Mode Application</label>
                            <div class="fullscreen-controls">
                                <button id="toggleFullscreen" class="btn btn-secondary">üî≤ Activer le mode plein √©cran</button>
                            </div>
                            <div class="pwa-info">
                                <div class="pwa-status" id="pwaStatus">
                                    <span class="pwa-icon">üì±</span>
                                    <span class="pwa-text">Pour une exp√©rience d'application native, ajoutez cette page √† votre √©cran d'accueil</span>
                                </div>
                                <button id="installPWA" class="btn btn-primary" style="margin-top: 8px; display: none;">‚¨áÔ∏è Installer l'application</button>
                            </div>
                        </div>

                        <div class="setting-actions">
                            <button id="saveSettings" class="btn btn-primary">
                                üíæ Sauvegarder les param√®tres
                            </button>
                            <button id="resetSettings" class="btn btn-secondary">
                                üîÑ R√©initialiser par d√©faut
                            </button>
                        </div>
                    </div>

                    <!-- Section WOL et Contr√¥le √† distance -->
                    <div class="section" style="margin-top: var(--ios-spacing-16);">
                        <h2>üì∂ Contr√¥le √† distance</h2>
                        
                        <div class="settings-form">
                            <!-- Configuration Wake-on-LAN -->
                            <div class="setting-group">
                                <label for="macAddress" class="setting-label">
                                    üóúÔ∏è Adresse MAC de votre PC
                                </label>
                                <input type="text" id="macAddress" class="setting-input" 
                                       placeholder="AA:BB:CC:DD:EE:FF ou AA-BB-CC-DD-EE-FF" 
                                       pattern="^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$">
                                <div class="setting-hint">
                                    Trouvez votre adresse MAC avec : <code>ipconfig /all</code> (Windows) ou <code>ifconfig</code> (Linux)
                                </div>
                            </div>
                            
                            <div class="setting-group">
                                <label for="shutdownServerUrl" class="setting-label">
                                    üåê URL du serveur shutdown
                                </label>
                                <input type="text" id="shutdownServerUrl" class="setting-input" 
                                       placeholder="http://192.168.1.100:8081">
                                <div class="setting-hint">
                                    Adresse de votre PC avec le serveur Python (port 8081)
                                </div>
                            </div>
                            
                            <div class="setting-group">
                                <label for="shutdownDelay" class="setting-label">
                                    ‚è≤Ô∏è D√©lai d'arr√™t (secondes)
                                </label>
                                <input type="number" id="shutdownDelay" class="setting-input" 
                                       min="10" max="3600" value="30">
                                <div class="setting-hint">
                                    Temps avant l'arr√™t/red√©marrage (10 √† 3600 secondes)
                                </div>
                            </div>
                            
                            <!-- Statut du serveur -->
                            <div class="setting-group">
                                <div class="remote-status">
                                    <div class="status-indicator" id="remoteStatusIndicator"></div>
                                    <span id="remoteStatusText">Statut inconnu</span>
                                    <button id="checkRemoteStatus" class="btn btn-secondary btn-small" style="margin-left: auto;">
                                        üîÑ V√©rifier
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Boutons de contr√¥le -->
                            <div class="remote-controls">
                                <div class="control-group">
                                    <h4>üîå Allumer le PC</h4>
                                    <button id="sendWOL" class="btn btn-primary" disabled>
                                        ‚ö° Wake-on-LAN
                                    </button>
                                    <div class="control-hint">R√©veille votre PC √† distance</div>
                                </div>
                                
                                <div class="control-group">
                                    <h4>üîå √âteindre/Red√©marrer</h4>
                                    <div class="control-buttons">
                                        <button id="shutdownPC" class="btn btn-danger" disabled>
                                            üîå √âteindre
                                        </button>
                                        <button id="rebootPC" class="btn btn-warning" disabled>
                                            üîÑ Red√©marrer
                                        </button>
                                        <button id="cancelShutdown" class="btn btn-secondary" disabled>
                                            ‚ùå Annuler
                                        </button>
                                    </div>
                                    <div class="control-hint">Contr√¥le l'alimentation de votre PC</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-info">
                            <h3>‚ö†Ô∏è Instructions d'installation</h3>
                            <ol>
                                <li><strong>Wake-on-LAN</strong> : Activez WOL dans le BIOS et les param√®tres r√©seau</li>
                                <li><strong>Serveur shutdown</strong> : Lancez <code>start-shutdown-server.bat</code> sur votre PC</li>
                                <li><strong>Port forwarding</strong> : Redirigez le port 8081 vers votre PC dans votre routeur</li>
                                <li><strong>Firewall</strong> : Autorisez le port 8081 dans le pare-feu Windows</li>
                                <li><strong>Adresse MAC</strong> : Utilisez <code>ipconfig /all</code> pour la trouver</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div class="settings-info">
                        <h3>‚ÑπÔ∏è Informations ComfyUI</h3>
                        <ul>
                            <li><strong>API REST</strong> : Utilis√©e pour envoyer les workflows et r√©cup√©rer les images</li>
                            <li><strong>WebSocket</strong> : Utilis√©e pour les previews temps r√©el et la progression</li>
                            <li><strong>Port par d√©faut</strong> : ComfyUI utilise g√©n√©ralement le port 8188 ou 8000</li>
                            <li><strong>HTTPS/WSS</strong> : N√©cessaire si l'interface est servie en HTTPS</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Navigation en bas avec ic√¥nes -->
            <div class="tabs bottom-nav">
                <button class="tab active" data-tab="workflow" title="Workflow">
                    <span class="tab-icon">üìã</span>
                    <span class="tab-label">Workflow</span>
                </button>
                <button class="tab" data-tab="quickgen" title="G√©n√©ration Rapide">
                    <span class="tab-icon">‚ö°</span>
                    <span class="tab-label">Quick Gen</span>
                </button>
                <button class="tab" data-tab="models" id="modelsTab" style="display: none;" title="Mod√®les">
                    <span class="tab-icon">üéØ</span>
                    <span class="tab-label">Mod√®les</span>
                </button>
                <a href="inpaint-app.html" class="tab" title="Inpainting" style="text-decoration: none;">
                    <span class="tab-icon">‚úèÔ∏è</span>
                    <span class="tab-label">Inpaint</span>
                </a>
                <button class="tab" data-tab="gallery" title="Galerie">
                    <span class="tab-icon">üñºÔ∏è</span>
                    <span class="tab-label">Galerie</span>
                </button>
                <button class="tab" data-tab="settings" title="Param√®tres">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span class="tab-label">Settings</span>
                </button>
            </div>
        </main>
    </div>

    <script src="wol-remote-control.js"></script>
    <script src="script.js"></script>
    
    <!-- Fullscreen & PWA Management Script -->
    <script>
        // ========================================
        // FULLSCREEN & PWA FUNCTIONALITY
        // ========================================
        
        class FullscreenManager {
            constructor() {
                this.isFullscreen = false;
                this.pwaInstallPrompt = null;
                this.init();
            }
            
            init() {
                // Bind events
                document.getElementById('toggleFullscreen')?.addEventListener('click', () => this.toggleFullscreen());
                document.getElementById('installPWA')?.addEventListener('click', () => this.installPWA());
                
                // Listen for fullscreen changes
                document.addEventListener('fullscreenchange', () => this.onFullscreenChange());
                document.addEventListener('webkitfullscreenchange', () => this.onFullscreenChange());
                
                // PWA install prompt
                window.addEventListener('beforeinstallprompt', (e) => this.onInstallPrompt(e));
                
                // Check if already installed as PWA
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    this.updatePWAStatus('installed');
                }
                
                this.updateUI();
            }
            
            async toggleFullscreen() {
                try {
                    if (!this.isFullscreen) {
                        // Enter fullscreen
                        const element = document.documentElement;
                        if (element.requestFullscreen) {
                            await element.requestFullscreen();
                        } else if (element.webkitRequestFullscreen) {
                            await element.webkitRequestFullscreen();
                        } else if (element.msRequestFullscreen) {
                            await element.msRequestFullscreen();
                        }
                        
                        // Add fullscreen class
                        document.body.classList.add('fullscreen-mode');
                        this.showIndicator('Mode plein √©cran activ√©');
                    } else {
                        // Exit fullscreen
                        if (document.exitFullscreen) {
                            await document.exitFullscreen();
                        } else if (document.webkitExitFullscreen) {
                            await document.webkitExitFullscreen();
                        } else if (document.msExitFullscreen) {
                            await document.msExitFullscreen();
                        }
                        
                        document.body.classList.remove('fullscreen-mode');
                        this.showIndicator('Mode plein √©cran d√©sactiv√©');
                    }
                } catch (error) {
                    console.error('Erreur fullscreen:', error);
                    this.showIndicator('Erreur lors du changement de mode', 'error');
                }
            }
            
            onFullscreenChange() {
                this.isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
                this.updateUI();
            }
            
            updateUI() {
                const btn = document.getElementById('toggleFullscreen');
                if (!btn) return;
                
                if (this.isFullscreen) {
                    btn.textContent = 'üî≥ Quitter le plein √©cran';
                    btn.classList.add('fullscreen-active');
                } else {
                    btn.textContent = 'üî≤ Activer le mode plein √©cran';
                    btn.classList.remove('fullscreen-active');
                }
            }
            
            onInstallPrompt(e) {
                e.preventDefault();
                this.pwaInstallPrompt = e;
                this.updatePWAStatus('installable');
            }
            
            async installPWA() {
                if (!this.pwaInstallPrompt) {
                    this.showIndicator('Installation PWA non disponible', 'error');
                    return;
                }
                
                try {
                    const result = await this.pwaInstallPrompt.prompt();
                    
                    if (result.outcome === 'accepted') {
                        this.updatePWAStatus('installing');
                        this.showIndicator('Installation de l\'application...', 'success');
                        
                        // Wait a bit then update status
                        setTimeout(() => {
                            this.updatePWAStatus('installed');
                            this.showIndicator('Application install√©e avec succ√®s!', 'success');
                        }, 2000);
                    }
                    
                    this.pwaInstallPrompt = null;
                } catch (error) {
                    console.error('Erreur lors de l\'installation PWA:', error);
                    this.showIndicator('Erreur lors de l\'installation', 'error');
                }
            }
            
            updatePWAStatus(status) {
                const statusEl = document.getElementById('pwaStatus');
                const installBtn = document.getElementById('installPWA');
                const textEl = statusEl?.querySelector('.pwa-text');
                
                if (!statusEl || !installBtn || !textEl) return;
                
                switch (status) {
                    case 'installable':
                        textEl.textContent = 'Application pr√™te √† √™tre install√©e';
                        statusEl.className = 'pwa-status installable';
                        installBtn.style.display = 'block';
                        break;
                        
                    case 'installing':
                        textEl.textContent = 'Installation en cours...';
                        statusEl.className = 'pwa-status installing';
                        installBtn.style.display = 'none';
                        break;
                        
                    case 'installed':
                        textEl.textContent = 'Application install√©e - Lancez-la depuis votre √©cran d\'accueil';
                        statusEl.className = 'pwa-status installed';
                        installBtn.style.display = 'none';
                        break;
                        
                    default:
                        textEl.textContent = 'Pour une exp√©rience d\'application native, ajoutez cette page √† votre √©cran d\'accueil';
                        statusEl.className = 'pwa-status';
                        installBtn.style.display = 'none';
                }
            }
            
            showIndicator(message, type = 'info') {
                // Remove existing indicator
                const existing = document.querySelector('.fullscreen-indicator');
                if (existing) {
                    existing.remove();
                }
                
                // Create new indicator
                const indicator = document.createElement('div');
                indicator.className = 'fullscreen-indicator';
                indicator.textContent = message;
                
                // Add type class
                if (type === 'success') {
                    indicator.classList.add('success');
                } else if (type === 'error') {
                    indicator.classList.add('error');
                }
                
                document.body.appendChild(indicator);
                
                // Auto remove after 3 seconds
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.remove();
                    }
                }, 3000);
            }
        }
        
        // ========================================
        // SPLASH SCREEN MANAGEMENT
        // ========================================
        
        class SplashScreenManager {
            constructor() {
                this.splashScreen = document.getElementById('splashScreen');
                this.minDisplayTime = 2000; // Minimum 2 seconds
                this.startTime = Date.now();
            }
            
            async hide() {
                const elapsedTime = Date.now() - this.startTime;
                const remainingTime = Math.max(0, this.minDisplayTime - elapsedTime);
                
                // Wait for minimum display time
                if (remainingTime > 0) {
                    await new Promise(resolve => setTimeout(resolve, remainingTime));
                }
                
                // Fade out animation
                if (this.splashScreen) {
                    this.splashScreen.style.opacity = '0';
                    this.splashScreen.style.transform = 'scale(0.95)';
                    
                    setTimeout(() => {
                        this.splashScreen.style.display = 'none';
                        document.body.classList.add('loaded');
                    }, 500);
                }
            }
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.fullscreenManager = new FullscreenManager();
            window.splashManager = new SplashScreenManager();
            
            // Simuler un chargement additionnel si n√©cessaire
            setTimeout(() => {
                if (window.splashManager) {
                    window.splashManager.hide();
                }
            }, 1500);
        });
        
        // Keyboard shortcut for fullscreen (F11)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11') {
                e.preventDefault();
                window.fullscreenManager?.toggleFullscreen();
            }
        });
        
        // ========================================
        // COLLAPSIBLE SECTIONS FUNCTIONALITY
        // ========================================
        
        function handleHeaderClick(event, contentId, header) {
            // Trouve le bouton collapse dans ce header
            const collapseBtn = header.querySelector('.collapse-btn');
            if (collapseBtn) {
                toggleSectionCollapse(contentId, collapseBtn);
            }
        }
        
        function toggleSectionCollapse(contentId, button) {
            const content = document.getElementById(contentId);
            const icon = button.querySelector('.collapse-icon');
            
            if (!content) return;
            
            // Pour les toggle-content qui sont en display: none, on les rend visibles d'abord
            if (content.classList.contains('toggle-content') && content.style.display === 'none') {
                content.style.display = 'block';
                content.style.maxHeight = content.scrollHeight + 'px';
                return; // Don't collapse on first click, just show
            }
            
            // Toggle collapsed state
            const isCollapsed = content.classList.contains('collapsed');
            
            if (isCollapsed) {
                // Expand
                content.classList.remove('collapsed');
                button.classList.remove('collapsed');
                icon.style.transform = 'rotate(0deg)';
                
                // For toggle-content, ensure it's visible
                if (content.classList.contains('toggle-content')) {
                    content.style.display = 'block';
                }
                
                // Store expanded state
                localStorage.setItem(`section_${contentId}_collapsed`, 'false');
                
                // Show with animation
                setTimeout(() => {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }, 10);
            } else {
                // Collapse
                content.style.maxHeight = content.scrollHeight + 'px';
                
                setTimeout(() => {
                    content.classList.add('collapsed');
                    button.classList.add('collapsed');
                    icon.style.transform = 'rotate(-90deg)';
                    content.style.maxHeight = '0px';
                    
                    // Store collapsed state
                    localStorage.setItem(`section_${contentId}_collapsed`, 'true');
                }, 10);
            }
        }
        
        // Initialize sections state from localStorage
        function initializeCollapsibleSections() {
            const sections = [
                'faceDetailerContent',
                'controlNetContent', 
                'lorasContent',
                'ksampler1Content',
                'ksampler2Content',
                'generationOptionsContent'
            ];
            
            sections.forEach(sectionId => {
                const content = document.getElementById(sectionId);
                const button = document.querySelector(`[onclick*="${sectionId}"]`);
                
                if (content && button) {
                    const isCollapsed = localStorage.getItem(`section_${sectionId}_collapsed`) === 'true';
                    
                    // Pour les toggle-content, g√®re le display: none initial
                    if (content.classList.contains('toggle-content')) {
                        if (!isCollapsed && content.style.display === 'none') {
                            // If should be expanded but currently hidden, show it
                            content.style.display = 'block';
                        }
                    }
                    
                    if (isCollapsed) {
                        content.classList.add('collapsed');
                        button.classList.add('collapsed');
                        button.querySelector('.collapse-icon').style.transform = 'rotate(-90deg)';
                        content.style.maxHeight = '0px';
                        
                        // For toggle-content, keep display block but collapsed
                        if (content.classList.contains('toggle-content')) {
                            content.style.display = 'block';
                        }
                    } else {
                        // Only set maxHeight if content is visible
                        if (content.style.display !== 'none') {
                            content.style.maxHeight = content.scrollHeight + 'px';
                        }
                    }
                }
            });
        }
        
        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeCollapsibleSections, 100);
        });
    </script>
</body>
</html>